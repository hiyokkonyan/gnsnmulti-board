<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マルチ募集掲示板</title>

    <link href="https://fonts.googleapis.com/css2?family=Rounded+Mplus+1c&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        body {
            font-family: 'Rounded Mplus 1c', 'Hiragino Maru Gothic Pro', 'Arial Rounded MT Bold', sans-serif;
            background: #f9f9f9;
            padding: 20px;
            color: #333;
        }

        h1 {
            font-size: 1.6em;
            margin-bottom: 0.8em;
            text-align: center;
            color: #5A8EA8;
        }

        .type-switcher {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        .type-switcher button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            background-color: #A8D1D1;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
            font-family: 'Rounded Mplus 1c', sans-serif;
            font-size: 0.9em;
        }

        .type-switcher button:hover {
            background-color: #8EB7B7;
        }

        .type-switcher button.active {
            background-color: #5A8EA8;
        }

        .post-form-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .post-form-container h2 {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #5A8EA8;
            text-align: center;
        }

        .post-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
            font-size: 0.9em;
        }

        .post-form input[type="text"],
        .post-form textarea,
        .post-form select {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
            font-family: 'Noto Sans JP', sans-serif;
            font-size: 0.9em;
        }

        .post-form textarea {
            resize: vertical;
            min-height: 80px;
        }

        .post-form button {
            width: 100%;
            padding: 12px;
            background-color: #5A8EA8;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
            font-family: 'Rounded Mplus 1c', sans-serif;
        }

        .post-form button:hover {
            background-color: #4A7A8A;
        }

        .posts-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .post {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            position: relative;
            word-wrap: break-word; /* 長い文字列の折り返し */
        }

        .post h3 {
            font-size: 1.4em;
            color: #333;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .post-content {
            margin-bottom: 10px;
            color: #555;
            line-height: 1.6;
            font-size: 0.95em;
            white-space: pre-wrap; /* 改行を反映 */
        }

        .post-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85em;
            color: #777;
            border-top: 1px solid #eee;
            padding-top: 10px;
            margin-top: 10px;
        }

        .post-footer .post-meta {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .uid-display {
            background-color: #eef;
            padding: 5px 8px;
            border-radius: 4px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .copy-button {
            background: none;
            border: none;
            color: #5A8EA8;
            cursor: pointer;
            font-size: 1em;
            margin-left: 5px;
            vertical-align: middle;
        }

        .copy-button:hover {
            color: #4A7A8A;
        }

        .post-actions {
            display: flex;
            gap: 10px;
        }

        .post-actions button {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
            font-family: 'Rounded Mplus 1c', sans-serif;
            transition: background-color 0.2s;
        }

        .delete-button {
            background-color: #ff6b6b;
            color: white;
        }

        .delete-button:hover {
            background-color: #e55a5a;
        }

        .edit-button {
            background-color: #6a99ff;
            color: white;
        }

        .edit-button:hover {
            background-color: #5a88e5;
        }

        .comment-button {
            background-color: #6BBE6B;
            color: white;
            position: relative; /* コメント数表示のためにrelativeに設定 */
            padding-right: 35px; /* コメント数表示のためのスペース */
        }

        .comment-button:hover {
            background-color: #5AAA5A;
        }

        .comment-count {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(255, 255, 255, 0.3);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.75em;
        }

        .comment-button.no-comments .comment-count {
            background-color: rgba(255, 255, 255, 0.2);
            color: #eee;
        }

        /* コメントセクションのスタイル */
        .comments-section {
            margin-top: 15px;
            border-top: 1px solid #eee;
            padding-top: 15px;
            display: none; /* 初期状態では非表示 */
        }

        .comments-section.active {
            display: block; /* activeクラスが付与されたら表示 */
        }

        .comment-list {
            margin-top: 15px;
        }

        .comment {
            background-color: #f5f5f5;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 0.9em;
            color: #444;
            position: relative; /* 削除ボタンの配置のため */
            word-wrap: break-word; /* 長い文字列の折り返し */
            white-space: pre-wrap; /* 改行を反映 */
        }

        .comment-author {
            font-weight: bold;
            color: #5A8EA8;
            margin-bottom: 5px;
            display: block;
        }

        .comment-timestamp {
            font-size: 0.75em;
            color: #888;
            text-align: right;
            margin-top: 5px;
        }

        .comment-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .comment-form input[type="text"],
        .comment-form textarea {
            width: calc(100% - 20px);
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
            font-family: 'Noto Sans JP', sans-serif;
        }

        .comment-form textarea {
            min-height: 60px;
            resize: vertical;
        }

        .comment-form button {
            padding: 10px 15px;
            background-color: #5A8EA8;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-family: 'Rounded Mplus 1c', sans-serif;
            transition: background-color 0.2s;
        }

        .comment-form button:hover {
            background-color: #4A7A8A;
        }

        .close-comments-button-container {
            display: flex;
            justify-content: flex-end; /* 右寄せ */
            margin-top: 10px; /* 「コメントする」ボタンとの間隔 */
        }

        .close-comments-button {
            background-color: #A8D1D1;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.85em;
            font-family: 'Rounded Mplus 1c', sans-serif;
            transition: background-color 0.2s;
        }

        .close-comments-button:hover {
            background-color: #8EB7B7;
        }

        .comment-delete-button {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            color: #ff6b6b;
            cursor: pointer;
            font-size: 0.8em;
            padding: 5px;
            opacity: 0.7;
        }

        .comment-delete-button:hover {
            opacity: 1;
        }
    </style>
</head>
<body>
    <h1>マルチ募集掲示板</h1>

    <div class="type-switcher">
        <button id="allPostsButton" class="active">全ての募集</button>
        <button id="myPostsButton">自分の募集</button>
    </div>

    <div class="post-form-container">
        <h2>新規募集投稿</h2>
        <form id="postForm" class="post-form">
            <label for="postName">名前 (任意):</label>
            <input type="text" id="postName" name="postName" placeholder="匿名">

            <label for="postType">募集種別:</label>
            <select id="postType" name="postType" required>
                <option value="全般">全般</option>
                <option value="攻略">攻略</option>
                <option value="周回">周回</option>
                <option value="イベント">イベント</option>
                <option value="その他">その他</option>
            </select>

            <label for="postTitle">タイトル:</label>
            <input type="text" id="postTitle" name="postTitle" required placeholder="例: ○○募集！">

            <label for="postContent">内容:</label>
            <textarea id="postContent" name="postContent" required placeholder="例: 一緒に○○をプレイしましょう！"></textarea>

            <label for="postUid">UID (任意):</label>
            <input type="text" id="postUid" name="postUid" placeholder="例: 123456789 (コピペ可能)">

            <button type="submit">投稿する</button>
        </form>
    </div>

    <div class="posts-container" id="postsContainer">
        </div>

    <script>
        // ========== 投稿機能関連のJavaScriptここから ==========

        // ローカルストレージから投稿をロード
        function loadPosts() {
            const postsJson = localStorage.getItem('posts');
            return postsJson ? JSON.parse(postsJson) : [];
        }

        // 投稿をローカルストレージに保存
        function savePosts(posts) {
            localStorage.setItem('posts', JSON.stringify(posts));
        }

        // UIDを生成
        function generateUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0,
                    v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // 新しい投稿を追加
        document.getElementById('postForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const postName = document.getElementById('postName').value || '匿名';
            const postType = document.getElementById('postType').value;
            const postTitle = document.getElementById('postTitle').value;
            const postContent = document.getElementById('postContent').value;
            const postUid = document.getElementById('postUid').value;
            const timestamp = Date.now();
            const postId = generateUID(); // 投稿ごとにユニークなIDを付与

            const newPost = {
                id: postId, // 投稿IDを追加
                name: postName,
                type: postType,
                title: postTitle,
                content: postContent,
                uid: postUid,
                timestamp: timestamp,
                comments: [] // コメント配列を初期化
            };

            const posts = loadPosts();
            posts.unshift(newPost); // 最新の投稿を配列の先頭に追加
            savePosts(posts);
            displayPosts();
            this.reset(); // フォームをリセット
        });

        // 投稿を表示
        function displayPosts() {
            const postsContainer = document.getElementById('postsContainer');
            postsContainer.innerHTML = '';
            const posts = loadPosts();

            const isMyPostsMode = document.getElementById('myPostsButton').classList.contains('active');
            let myUid = localStorage.getItem('myUid');
            if (isMyPostsMode && !myUid) {
                myUid = generateUID();
                localStorage.setItem('myUid', myUid);
            }

            posts.forEach(post => {
                // 「自分の募集」モードの場合、myUid と post.uid が一致しない投稿はスキップ
                if (isMyPostsMode && post.uid !== myUid) {
                    return;
                }

                const postElement = document.createElement('div');
                postElement.classList.add('post');
                postElement.dataset.timestamp = post.timestamp; // コメント機能で使うため追加
                postElement.dataset.postId = post.id; // コメント機能で使うため追加

                const postDate = new Date(post.timestamp);
                const formattedDate = postDate.toLocaleString('ja-JP', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                let uidDisplay = '';
                if (post.uid) {
                    uidDisplay = `
                        <div class="uid-display">
                            UID: ${post.uid}
                            <button class="copy-button" data-uid="${post.uid}" aria-label="UIDをコピー">
                                <i class="far fa-copy"></i>
                            </button>
                        </div>
                    `;
                }

                postElement.innerHTML = `
                    <h3>${post.title} (${post.type})</h3>
                    <div class="post-content">${post.content.replace(/\n/g, '<br>')}</div>
                    <div class="post-footer">
                        <div class="post-meta">
                            <span>投稿者: ${post.name}</span>
                            <span>投稿日時: ${formattedDate}</span>
                            ${uidDisplay}
                        </div>
                        <div class="post-actions">
                            <button class="comment-button" aria-label="コメントを見る/閉じる">
                                <i class="fas fa-comment"></i> <span class="comment-count">...</span>
                            </button>
                            <button class="edit-button" data-timestamp="${post.timestamp}" aria-label="編集">編集</button>
                            <button class="delete-button" data-timestamp="${post.timestamp}" aria-label="削除">削除</button>
                        </div>
                    </div>
                    <div class="comments-section">
                        <div class="comment-list">
                            </div>
                        <form class="comment-form">
                            <input type="text" placeholder="名前 (任意)" class="comment-name-input">
                            <textarea placeholder="コメントを入力" class="comment-content-input" required></textarea>
                            <button type="submit">コメントする</button>
                        </form>
                        <div class="close-comments-button-container">
                            <button class="close-comments-button" aria-label="コメントを閉じる">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
                postsContainer.appendChild(postElement);

                // コメント表示を更新
                updateCommentCountDisplay(postElement);
                displayComments(postElement);
            });

            addCopyBlockers(); // UIDコピー阻害イベントリスナーを再追加
            addCopyButtonListeners(); // コピーボタンのリスナーを再追加
            addDeleteEditListeners(); // 削除・編集ボタンのリスナーを再追加
            addCommentToggleListeners(); // コメント開閉ボタンのリスナーを再追加
            addCommentFormListeners(); // コメントフォームのリスナーを再追加
        }

        // UIDコピーボタンのイベントリスナー
        function addCopyButtonListeners() {
            document.querySelectorAll('.copy-button').forEach(button => {
                button.addEventListener('click', function(e) {
                    e.stopPropagation(); // イベントのバブリングを防ぐ
                    const uidToCopy = this.dataset.uid;
                    navigator.clipboard.writeText(uidToCopy).then(() => {
                        const originalIcon = this.innerHTML;
                        this.innerHTML = '<i class="fas fa-check"></i>'; // コピー成功アイコン
                        setTimeout(() => {
                            this.innerHTML = originalIcon; // 元に戻す
                        }, 1000);
                    }).catch(err => {
                        console.error('UIDのコピーに失敗しました:', err);
                    });
                });
            });
        }

        // 削除・編集ボタンのイベントリスナー
        function addDeleteEditListeners() {
            document.querySelectorAll('.delete-button').forEach(button => {
                button.addEventListener('click', function() {
                    const timestamp = parseInt(this.dataset.timestamp);
                    if (confirm('この投稿を削除しますか？')) {
                        let posts = loadPosts();
                        posts = posts.filter(post => post.timestamp !== timestamp);
                        savePosts(posts);
                        displayPosts();
                    }
                });
            });

            document.querySelectorAll('.edit-button').forEach(button => {
                button.addEventListener('click', function() {
                    const timestamp = parseInt(this.dataset.timestamp);
                    const posts = loadPosts();
                    const postToEdit = posts.find(post => post.timestamp === timestamp);

                    if (postToEdit) {
                        const newTitle = prompt('新しいタイトルを入力してください:', postToEdit.title);
                        if (newTitle === null) return; // キャンセルされた場合
                        const newContent = prompt('新しい内容を入力してください:', postToEdit.content);
                        if (newContent === null) return; // キャンセルされた場合

                        postToEdit.title = newTitle;
                        postToEdit.content = newContent;
                        savePosts(posts);
                        displayPosts();
                    }
                });
            });
        }

        // 「自分の募集」ボタンと「全ての募集」ボタンの切り替え
        document.getElementById('myPostsButton').addEventListener('click', function() {
            this.classList.add('active');
            document.getElementById('allPostsButton').classList.remove('active');
            displayPosts();
        });

        document.getElementById('allPostsButton').addEventListener('click', function() {
            this.classList.add('active');
            document.getElementById('myPostsButton').classList.remove('active');
            localStorage.removeItem('myUid'); // 全ての募集表示時はmyUidをクリア
            displayPosts();
        });

        // ========== 投稿機能関連のJavaScriptここまで ==========


        // ========== コメント機能関連のJavaScriptここから ==========

        // コメント開閉ボタンのイベントリスナー
        function addCommentToggleListeners() {
            document.querySelectorAll('.comment-button').forEach(button => {
                button.removeEventListener('click', toggleComments); // 既存のリスナーを削除
                button.addEventListener('click', toggleComments); // 新しいリスナーを追加
            });
            document.querySelectorAll('.close-comments-button').forEach(button => {
                button.removeEventListener('click', closeComments); // 既存のリスナーを削除
                button.addEventListener('click', closeComments); // 新しいリスナーを追加
            });
        }

        function toggleComments(e) {
            // コメントカウント部分がクリックされても開閉するようにイベントターゲットを調整
            const targetButton = e.currentTarget.closest('.comment-button');
            if (!targetButton) return; // ボタンが見つからない場合は処理を中断

            const postElement = targetButton.closest('.post');
            if (!postElement) return; // 投稿要素が見つからない場合は処理を中断

            const commentsSection = postElement.querySelector('.comments-section');
            commentsSection.classList.toggle('active');
        }

        function closeComments(e) {
            const targetButton = e.currentTarget;
            const postElement = targetButton.closest('.post');
            if (!postElement) return;

            const commentsSection = postElement.querySelector('.comments-section');
            commentsSection.classList.remove('active');
        }

        // コメントフォームのイベントリスナー
        function addCommentFormListeners() {
            document.querySelectorAll('.comment-form').forEach(form => {
                form.removeEventListener('submit', handleCommentSubmit); // 既存のリスナーを削除
                form.addEventListener('submit', handleCommentSubmit); // 新しいリスナーを追加
            });
        }

        function handleCommentSubmit(e) {
            e.preventDefault();
            const postElement = e.target.closest('.post');
            const postTimestamp = parseInt(postElement.dataset.timestamp);
            const commentNameInput = e.target.querySelector('.comment-name-input');
            const commentContentInput = e.target.querySelector('.comment-content-input');

            const commentName = commentNameInput.value || '匿名';
            const commentContent = commentContentInput.value;
            const commentTimestamp = Date.now();

            if (commentContent.trim() !== '') {
                const posts = loadPosts();
                const post = posts.find(p => p.timestamp === postTimestamp);
                if (post) {
                    if (!post.comments) {
                        post.comments = [];
                    }
                    post.comments.push({
                        name: commentName,
                        content: commentContent,
                        timestamp: commentTimestamp
                    });
                    savePosts(posts);
                    displayComments(postElement); // コメントを再表示
                    updateCommentCountDisplay(postElement); // コメント数を更新
                    commentContentInput.value = ''; // コメント入力欄をクリア
                    // 名前は保持するかクリアするかは要件次第だが、ここではクリアしない
                }
            }
        }

        // コメント数を更新する
        function updateCommentCountDisplay(postElement) {
            const postTimestamp = parseInt(postElement.dataset.timestamp);
            const posts = loadPosts();
            const post = posts.find(p => p.timestamp === postTimestamp);
            if (!post) return;

            const commentCount = post.comments ? post.comments.length : 0;
            const commentButton = postElement.querySelector('.comment-button');
            const commentCountSpan = commentButton.querySelector('.comment-count');

            commentCountSpan.textContent = commentCount === 0 ? '...' : commentCount;
            if (commentCount === 0) {
                commentButton.classList.add('no-comments');
            } else {
                commentButton.classList.remove('no-comments');
            }
        }

        // コメントを表示
        function displayComments(postElement) {
            const postTimestamp = parseInt(postElement.dataset.timestamp);
            const posts = loadPosts();
            const post = posts.find(p => p.timestamp === postTimestamp);
            if (!post) return;

            const commentList = postElement.querySelector('.comment-list');
            commentList.innerHTML = ''; // 既存のコメントをクリア

            if (post.comments && post.comments.length > 0) {
                post.comments.forEach((comment, index) => {
                    const commentElement = document.createElement('div');
                    commentElement.classList.add('comment');

                    const commentDate = new Date(comment.timestamp);
                    const formattedCommentDate = commentDate.toLocaleString('ja-JP', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });

                    commentElement.innerHTML = `
                        <span class="comment-author">${comment.name}</span>
                        <div class="comment-content">${comment.content.replace(/\n/g, '<br>')}</div>
                        <div class="comment-timestamp">${formattedCommentDate}</div>
                        <button class="comment-delete-button" data-comment-index="${index}" data-post-timestamp="${postTimestamp}" aria-label="コメントを削除">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    `;
                    commentList.appendChild(commentElement);
                });
                addCommentDeleteListeners(); // コメント削除ボタンのリスナーを追加
            } else {
                commentList.innerHTML = '<p style="text-align: center; color: #888; font-size: 0.9em;">まだコメントはありません。</p>';
            }
        }

        // コメント削除ボタンのイベントリスナー
        function addCommentDeleteListeners() {
            document.querySelectorAll('.comment-delete-button').forEach(button => {
                button.removeEventListener('click', handleCommentDelete); // 既存のリスナーを削除
                button.addEventListener('click', handleCommentDelete); // 新しいリスナーを追加
            });
        }

        function handleCommentDelete(e) {
            const commentIndex = parseInt(e.currentTarget.dataset.commentIndex);
            const postTimestamp = parseInt(e.currentTarget.dataset.postTimestamp);

            if (confirm('このコメントを削除しますか？')) {
                const posts = loadPosts();
                const post = posts.find(p => p.timestamp === postTimestamp);

                if (post && post.comments) {
                    post.comments.splice(commentIndex, 1); // 指定したインデックスのコメントを削除
                    savePosts(posts);
                    const postElement = e.currentTarget.closest('.post');
                    displayComments(postElement); // コメントを再表示
                    updateCommentCountDisplay(postElement); // コメント数を更新
                }
            }
        }

        // ========== コメント機能関連のJavaScriptここまで ==========


        // ページ読み込み時に投稿を表示
        document.addEventListener("DOMContentLoaded", displayPosts);

        // UIDのコピーを阻害するイベントリスナーを追加する関数
        function addCopyBlockers() {
            document.querySelectorAll('.copy-button').forEach(button => {
                button.addEventListener('mousedown', (e) => e.preventDefault());
            });
        }
    </script>
</body>
</html>