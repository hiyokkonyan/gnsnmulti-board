<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マルチ募集掲示板</title>

    <link href="https://fonts.googleapis.com/css2?family=Rounded+Mplus+1c&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        body {
            font-family: 'Rounded Mplus 1c', 'Hiragino Maru Gothic Pro', 'Arial Rounded MT Bold', sans-serif;
            background: #f9f9f9;
            padding: 20px;
            color: #333;
        }

        h1 {
            font-size: 1.6em;
            margin-bottom: 0.8em;
            text-align: center;
            color: #5A8EA8;
        }

        .type-switcher {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        .type-button {
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            background-color: #e0e0e0;
            cursor: pointer;
            font-size: 0.9em;
            color: #555;
            transition: background-color 0.2s, color 0.2s;
        }

        .type-button.active {
            background-color: #5A8EA8;
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .post-form {
            background-color: #f0f8ff;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .post-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #444;
        }

        .post-form input[type="text"],
        .post-form textarea,
        .post-form select {
            width: calc(100% - 20px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1em;
            box-sizing: border-box;
        }

        .post-form textarea {
            resize: vertical;
            min-height: 80px;
        }

        .post-form button {
            background-color: #5A8EA8;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: background-color 0.2s ease, transform 0.1s ease;
            display: block;
            margin: 0 auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .post-form button:hover {
            background-color: #4A7C92;
            transform: translateY(-2px);
        }

        .post-list {
            margin-top: 20px;
        }

        .post-card {
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .post-title {
            font-size: 1.3em;
            color: #333;
            margin: 0;
            word-break: break-word;
        }

        .post-meta {
            font-size: 0.85em;
            color: #777;
            text-align: right;
            white-space: nowrap;
        }

        .post-meta .timestamp {
            display: block;
            margin-top: 5px;
        }

        .post-content {
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-bottom: 15px;
            color: #444;
            line-height: 1.6;
        }

        .post-footer {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
        }

        .copy-button {
            background-color: #007bff;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
            text-decoration: none; /* UIDボタンのリンク下線をなくす */
        }

        .copy-button:hover {
            background-color: #0056b3;
        }

        .delete-button {
            background-color: #dc3545;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background-color 0.2s ease;
        }

        .delete-button:hover {
            background-color: #c82333;
        }

        /* コメント機能関連のスタイル */
        .comment-section {
            border-top: 1px dashed #e0e0e0;
            padding-top: 15px;
            margin-top: 15px;
            position: relative; /* comment-toggle の位置決めの基準 */
        }

        .comment-input-area {
            display: none; /* 初期状態では非表示 */
            margin-bottom: 15px;
        }

        .comment-input-area.active {
            display: block; /* コメントボタンクリックで表示 */
        }

        .comment-input-area label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #444;
        }

        .comment-input-area input[type="text"],
        .comment-input-area textarea {
            width: calc(100% - 20px);
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.95em;
            box-sizing: border-box;
        }

        .comment-input-area textarea {
            min-height: 60px;
            resize: vertical;
        }

        .comment-submit-button {
            background-color: #28a745;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s ease;
            /* comment-toggleのposition: absoluteの基準をここにするため追加 */
            position: relative; 
        }

        .comment-submit-button:hover {
            background-color: #218838;
        }

        .comment-list {
            margin-top: 15px;
            padding-left: 0;
            list-style: none;
        }

        .comment-item {
            background-color: #f8f8f8;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px 15px;
            margin-bottom: 10px;
            word-break: break-word;
            position: relative; /* コメント削除ボタンの位置決めの基準 */
        }

        .comment-name {
            font-weight: bold;
            color: #555;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .comment-content {
            color: #333;
            line-height: 1.5;
            font-size: 0.9em;
        }

        .comment-timestamp {
            font-size: 0.75em;
            color: #999;
            text-align: right;
            margin-top: 5px;
        }

        .comment-button {
            background-color: #6c757d;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background-color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .comment-button:hover {
            background-color: #5a6268;
        }

        .comment-button.no-comments {
            background-color: #888;
        }

        .comment-count {
            margin-left: 5px;
        }

        .comment-toggle {
            /* 修正ここから */
            position: absolute;
            bottom: -35px; /* コメントするボタンの下に配置するために調整 */
            right: 0px; /* コメントするボタンの右端に合わせるために調整 */
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 50%; /* 丸いボタンにする */
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1em;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: background-color 0.2s ease, transform 0.2s ease;
            z-index: 10; /* 他の要素より手前に表示 */
            /* 修正ここまで */
        }

        .comment-toggle:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }

        .comment-toggle .fa-chevron-down,
        .comment-toggle .fa-chevron-up {
            transition: transform 0.3s ease;
        }

        .comment-toggle.expanded .fa-chevron-down {
            transform: rotate(180deg);
        }

        .comment-delete-button {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 3px 8px;
            font-size: 0.7em;
            cursor: pointer;
            position: absolute;
            top: 5px;
            right: 5px;
            transition: background-color 0.2s ease;
        }

        .comment-delete-button:hover {
            background-color: #c82333;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .container {
                padding: 15px;
            }

            .post-form {
                padding: 15px;
            }

            .post-form input[type="text"],
            .post-form textarea,
            .post-form select {
                width: calc(100% - 16px);
                padding: 8px;
            }

            .post-card {
                padding: 15px;
            }

            .post-title {
                font-size: 1.1em;
            }

            .post-meta {
                font-size: 0.75em;
            }

            .post-content {
                font-size: 0.9em;
            }

            .copy-button,
            .delete-button,
            .comment-button {
                padding: 5px 10px;
                font-size: 0.7em;
            }

            .comment-input-area input[type="text"],
            .comment-input-area textarea {
                width: calc(100% - 16px);
                padding: 6px;
            }

            .comment-submit-button {
                padding: 6px 12px;
                font-size: 0.8em;
            }

            .comment-item {
                padding: 8px 12px;
            }

            .comment-name,
            .comment-content {
                font-size: 0.8em;
            }

            .comment-timestamp {
                font-size: 0.65em;
            }

            .comment-toggle {
                width: 25px;
                height: 25px;
                font-size: 0.9em;
                right: 5px; /* モバイルでの位置調整 */
                bottom: -30px; /* モバイルでの位置調整 */
            }
        }
    </style>
</head>
<body>
    <h1>マルチ募集掲示板</h1>

    <div class="type-switcher">
        <button class="type-button active" data-type="all">すべて</button>
        <button class="type-button" data-type="recruitment">募集</button>
        <button class="type-button" data-type="seeking">参加希望</button>
    </div>

    <div class="container">
        <div class="post-form">
            <label for="post-type">投稿タイプ:</label>
            <select id="post-type">
                <option value="recruitment">募集</option>
                <option value="seeking">参加希望</option>
            </select>

            <label for="post-title">タイトル:</label>
            <input type="text" id="post-title" maxlength="50" placeholder="例: 〇〇募集、〇〇手伝ってほしい！" />

            <label for="post-content">内容:</label>
            <textarea id="post-content" rows="5" maxlength="300" placeholder="例: Lv.〇〇〜、ランク〇〇〜、〇〇＠1"></textarea>

            <label for="user-name">名前 (任意):</label>
            <input type="text" id="user-name" maxlength="20" placeholder="名前" />

            <label for="uid">UID (任意、コピーされます):</label>
            <input type="text" id="uid" maxlength="20" placeholder="UID" />

            <button onclick="submitPost()">投稿する</button>
        </div>

        <div class="post-list" id="post-list">
            </div>
    </div>

    <script>
        // ローカルストレージから投稿をロード
        function loadPosts() {
            const posts = localStorage.getItem('posts');
            return posts ? JSON.parse(posts) : [];
        }

        // 投稿をローカルストレージに保存
        function savePosts(posts) {
            localStorage.setItem('posts', JSON.stringify(posts));
        }

        // 投稿を表示
        function displayPosts(filterType = 'all') {
            const postList = document.getElementById('post-list');
            postList.innerHTML = ''; // 既存の投稿をクリア

            let posts = loadPosts();

            // 投稿を新しい順にソート
            posts.sort((a, b) => b.timestamp - a.timestamp);

            if (filterType !== 'all') {
                posts = posts.filter(post => post.type === filterType);
            }

            if (posts.length === 0) {
                postList.innerHTML = '<p style="text-align: center; color: #777;">まだ投稿がありません。</p>';
                return;
            }

            posts.forEach(post => {
                const postElement = document.createElement('div');
                postElement.classList.add('post-card');
                postElement.dataset.timestamp = post.timestamp; // タイムスタンプをデータ属性として保持

                const formattedDate = new Date(post.timestamp).toLocaleString('ja-JP', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const userNameDisplay = post.userName ? `<span>${escapeHTML(post.userName)}</span>` : '<span style="color: #bbb;">名無しさん</span>';
                const uidButton = post.uid ? `<a href="#" class="copy-button" onclick="copyUID(event, '${escapeHTML(post.uid)}')"><i class="far fa-copy"></i> ${escapeHTML(post.uid)}</a>` : '';

                postElement.innerHTML = `
                    <div class="post-header">
                        <h2 class="post-title">[${post.type === 'recruitment' ? '募集' : '参加希望'}] ${escapeHTML(post.title)}</h2>
                        <div class="post-meta">
                            ${userNameDisplay}
                            <span class="timestamp">${formattedDate}</span>
                        </div>
                    </div>
                    <p class="post-content">${escapeHTML(post.content)}</p>
                    <div class="post-footer">
                        ${uidButton}
                        <button class="comment-button" onclick="toggleCommentSection(this)">
                            <i class="far fa-comment-dots"></i> コメント <span class="comment-count">...</span>
                        </button>
                        <button class="delete-button" onclick="deletePost(${post.timestamp})">
                            <i class="fas fa-trash-alt"></i> 削除
                        </button>
                    </div>
                    <div class="comment-section">
                        <div class="comment-input-area">
                            <label for="comment-name-${post.timestamp}">名前 (任意):</label>
                            <input type="text" id="comment-name-${post.timestamp}" maxlength="20" placeholder="名前" />
                            <label for="comment-content-${post.timestamp}">コメント:</label>
                            <textarea id="comment-content-${post.timestamp}" rows="3" maxlength="200" placeholder="コメントを入力"></textarea>
                            <button class="comment-submit-button" onclick="submitComment(${post.timestamp})">コメントする</button>
                        </div>
                        <div class="comment-toggle" onclick="toggleCommentSection(this.previousElementSibling.querySelector('.comment-submit-button'))">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <ul class="comment-list" id="comment-list-${post.timestamp}">
                            </ul>
                    </div>
                `;
                postList.appendChild(postElement);
                updateCommentCountDisplay(postElement); // コメント数を更新
                displayComments(post.timestamp); // 各投稿のコメントを表示
            });
            addCopyBlockers(); // UIDコピー阻害イベントリスナーを追加
        }

        // HTMLエスケープ処理
        function escapeHTML(str) {
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        // 投稿を送信
        function submitPost() {
            const postType = document.getElementById('post-type').value;
            const postTitle = document.getElementById('post-title').value.trim();
            const postContent = document.getElementById('post-content').value.trim();
            const userName = document.getElementById('user-name').value.trim();
            const uid = document.getElementById('uid').value.trim();

            if (!postTitle || !postContent) {
                alert('タイトルと内容を入力してください。');
                return;
            }

            const posts = loadPosts();
            const newPost = {
                type: postType,
                title: postTitle,
                content: postContent,
                userName: userName,
                uid: uid,
                timestamp: Date.now(), // ユニークなタイムスタンプ
                comments: [] // コメント配列を初期化
            };

            posts.push(newPost);
            savePosts(posts);

            document.getElementById('post-title').value = '';
            document.getElementById('post-content').value = '';
            document.getElementById('user-name').value = '';
            document.getElementById('uid').value = '';

            displayPosts(document.querySelector('.type-button.active').dataset.type); // 現在のフィルターで再表示
        }

        // 投稿を削除
        function deletePost(timestamp) {
            if (!confirm('本当にこの投稿を削除しますか？')) {
                return;
            }

            let posts = loadPosts();
            posts = posts.filter(post => post.timestamp !== timestamp);
            savePosts(posts);
            displayPosts(document.querySelector('.type-button.active').dataset.type); // 現在のフィルターで再表示
        }

        // UIDをコピー
        function copyUID(event, uid) {
            event.preventDefault(); // リンクのデフォルト動作をキャンセル
            navigator.clipboard.writeText(uid).then(() => {
                alert('UIDをコピーしました: ' + uid);
            }).catch(err => {
                console.error('UIDのコピーに失敗しました', err);
                alert('UIDのコピーに失敗しました。');
            });
        }

        // タイプボタンのクリックイベント
        document.querySelectorAll('.type-button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.type-button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                displayPosts(button.dataset.type);
            });
        });

        // ========== コメント機能関連のJavaScriptここから ==========

        // コメントセクションの表示/非表示を切り替える
        function toggleCommentSection(triggerElement) {
            const commentSection = triggerElement.closest('.comment-section');
            const commentInputArea = commentSection.querySelector('.comment-input-area');
            const commentList = commentSection.querySelector('.comment-list');
            const commentToggle = commentSection.querySelector('.comment-toggle');

            commentInputArea.classList.toggle('active'); // 入力欄の表示/非表示を切り替え
            commentToggle.classList.toggle('expanded'); // アイコンの向きを切り替え

            if (commentInputArea.classList.contains('active')) {
                // コメント欄が開かれたら、コメントリストも表示する
                commentList.style.display = 'block';
            } else {
                // コメント欄が閉じられたら、コメントリストも非表示にする
                commentList.style.display = 'none';
            }
        }


        // コメントを表示
        function displayComments(postTimestamp) {
            const posts = loadPosts();
            const post = posts.find(p => p.timestamp === postTimestamp);
            if (!post || !post.comments) return;

            const commentListElement = document.getElementById(`comment-list-${postTimestamp}`);
            commentListElement.innerHTML = ''; // 既存のコメントをクリア

            post.comments.sort((a, b) => a.timestamp - b.timestamp); // コメントを古い順にソート

            post.comments.forEach(comment => {
                const commentItem = document.createElement('li');
                commentItem.classList.add('comment-item');
                commentItem.dataset.commentTimestamp = comment.timestamp; // コメントのタイムスタンプを保持

                const formattedDate = new Date(comment.timestamp).toLocaleString('ja-JP', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const commentNameDisplay = comment.userName ? `<div class="comment-name">${escapeHTML(comment.userName)}</div>` : '<div class="comment-name" style="color: #bbb;">名無しさん</div>';

                commentItem.innerHTML = `
                    ${commentNameDisplay}
                    <div class="comment-content">${escapeHTML(comment.content)}</div>
                    <div class="comment-timestamp">${formattedDate}</div>
                    <button class="comment-delete-button" onclick="deleteComment(${postTimestamp}, ${comment.timestamp})">削除</button>
                `;
                commentListElement.appendChild(commentItem);
            });
        }

        // コメントを送信
        function submitComment(postTimestamp) {
            const commentNameInput = document.getElementById(`comment-name-${postTimestamp}`);
            const commentContentInput = document.getElementById(`comment-content-${postTimestamp}`);

            const userName = commentNameInput.value.trim();
            const content = commentContentInput.value.trim();

            if (!content) {
                alert('コメント内容を入力してください。');
                return;
            }

            let posts = loadPosts();
            const postIndex = posts.findIndex(p => p.timestamp === postTimestamp);

            if (postIndex !== -1) {
                const newComment = {
                    userName: userName,
                    content: content,
                    timestamp: Date.now()
                };
                if (!posts[postIndex].comments) {
                    posts[postIndex].comments = [];
                }
                posts[postIndex].comments.push(newComment);
                savePosts(posts);
                displayComments(postTimestamp); // コメントを再表示
                const postElement = document.querySelector(`.post-card[data-timestamp="${postTimestamp}"]`);
                updateCommentCountDisplay(postElement); // コメント数を更新
                commentContentInput.value = ''; // コメント入力欄をクリア
                // 名前は保持するかクリアするかは要件次第だが、ここではクリアしない
            }
        }

        // コメントを削除
        function deleteComment(postTimestamp, commentTimestamp) {
            if (!confirm('本当にこのコメントを削除しますか？')) {
                return;
            }

            let posts = loadPosts();
            const postIndex = posts.findIndex(p => p.timestamp === postTimestamp);

            if (postIndex !== -1 && posts[postIndex].comments) {
                posts[postIndex].comments = posts[postIndex].comments.filter(comment => comment.timestamp !== commentTimestamp);
                savePosts(posts);
                displayComments(postTimestamp); // コメントを再表示
                const postElement = document.querySelector(`.post-card[data-timestamp="${postTimestamp}"]`);
                updateCommentCountDisplay(postElement); // コメント数を更新
            }
        }

        // コメント数を更新する
        function updateCommentCountDisplay(postElement) {
            const postTimestamp = parseInt(postElement.dataset.timestamp);
            const posts = loadPosts();
            const post = posts.find(p => p.timestamp === postTimestamp);
            if (!post) return;

            const commentCount = post.comments ? post.comments.length : 0;
            const commentButton = postElement.querySelector('.comment-button');
            const commentCountSpan = commentButton.querySelector('.comment-count');

            commentCountSpan.textContent = commentCount === 0 ? '...' : commentCount;
            if (commentCount === 0) {
                commentButton.classList.add('no-comments');
            } else {
                commentButton.classList.remove('no-comments');
            }
        }

        // ========== コメント機能関連のJavaScriptここまで ==========


        // ページ読み込み時に投稿を表示
        document.addEventListener("DOMContentLoaded", displayPosts);

        // UIDのコピーを阻害するイベントリスナーを追加する関数
        function addCopyBlockers() {
            document.querySelectorAll('.copy-button').forEach(button => {
                button.addEventListener('mousedown', (e) => e.preventDefault());
            });
        }
    </script>
</body>
</html>